---
title: "report-COVID-19"
author: "Thomas Gredig"
date: "3/17/2020"
output: 
  rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message  = FALSE)
library(ggplot2)
library(ggrepel)
library(reshape2)
library(knitr)
library(dplyr)
scientific_10 <- function(x) {
    xout <- gsub("1e", "10^{", format(x),fixed=TRUE)
    xout <- gsub("{-0", "{-", xout,fixed=TRUE)
    xout <- gsub("{+", "{", xout,fixed=TRUE)
    xout <- gsub("{0", "{", xout,fixed=TRUE)
    xout <- paste(xout,"}",sep="")
    return(parse(text=xout))
}
scale_y_log10nice <- function(name=NULL,omag=seq(-10,20),...) {
    breaks10 <- 10^omag
    scale_y_log10(name,breaks=breaks10,labels=scientific_10(breaks10),...)
}
scale_x_log10nice <- function(name=NULL,omag=seq(-10,20),...) {
    breaks10 <- 10^omag
    scale_x_log10(name,breaks=breaks10,labels=scientific_10(breaks10),...)
}
```

# COVID-19

We are comparing the growth rates in different regions. Using a 1-fit exponential model, the confirmed cases generally fit the model well. The doubling time is then compared.

The data is from the [CSSE COVID-19 Dataset](https://github.com/CSSEGISandData/COVID-19) after analysis of [Coronavirus by Tomas Pueyo](https://medium.com/@tomaspueyo/coronavirus-act-today-or-people-will-die-f4d3d9cd99ca). 

Projections based on [SIR models](https://www.maa.org/press/periodicals/loci/joma/the-sir-model-for-spread-of-disease-the-differential-equation-model) from [HealthData](https://covid19.healthdata.org/projections).


```{r}
dc = read.csv('data/population-by-country-2015.csv', stringsAsFactors = FALSE)
getPopulation <- function(countryName) {
  countryName = gsub('\\*','',countryName)
  if (countryName=='US') { countryName='United States' }
  if (countryName=='Czechia') { countryName ='Czech Republic'}
  if (countryName=='Korea, South') { countryName = 'South Korea' }
  mc = which(dc$country==countryName)
  if (length(mc)>= 1) { p = dc$p[mc] } else { p=1e12 }
  p
}
```


## Time Series

Regions with more than 5,000 confirmed cases increased rapidly from a few to many.

```{r}
path.series = 'csse_covid_19_data/csse_covid_19_time_series'
file.list = dir(path.series, pattern='csv$')
filename = 'time_series_covid19_confirmed_global.csv' # file.list[1]
f = file.path(path.series, filename)
d = read.csv(f)
d1 = d[,-c(1,3,4)]
m1 = melt(d1)
names(m1) = c('Region','Date','Confirmed')
m1$Date = gsub('^X','',as.character(levels(m1$Date)[m1$Date]))
m1$Date = as.Date(m1$Date, format='%m.%d.%y')

NUM.CASES = 5000
SEL.DATE = max(m1$Date)
m2 = subset(m1, Date==SEL.DATE)
m3 = aggregate(m2$Confirmed, by=list(m2$Region), FUN=sum)
names(m3) = c('Region','Confirmed')
m3 = subset(m3, Confirmed>NUM.CASES)
m3$Region = levels(m3$Region)[m3$Region]
m3$population = sapply(m3$Region, getPopulation)
```

On `r max(m1$Date)`, we have:

```{r}
ggplot(m3, aes(x=reorder(Region, Confirmed/population), y=Confirmed/population*1e6)) + 
  geom_bar(stat='identity', fill='red') + 
  geom_bar(stat='identity', fill='blue', data=subset(m3,Region=='US')) + 
  xlab('Confirmed cases per Thousand Population') +
  ggtitle(paste("More than",NUM.CASES,"confirmed COVID-19 on",SEL.DATE),subtitle = 'Source: Johns Hopkins CSSE') + 
  scale_y_log10nice() + 
  coord_flip() + 
  theme_bw(base_size = 8) 
top.regions = levels(factor(m3$Region))
```


```{r}
m4 = aggregate(m1$Confirmed, by=list(m1$Region, m1$Date), FUN=sum)
names(m4) = c('Region','Date','Confirmed')
m4p = which(m4$Region %in% top.regions)
m5 = m4[m4p,]
m5 %>%
  filter(Date > "2020-02-14") %>%
  ggplot(aes(Date, Confirmed, col=Region)) + 
    geom_line() + 
    scale_y_log10nice(limits=c(100,3e6),name='confirmed COVID-19 cases') + ylab('') + 
    theme_bw() + theme(legend.position = 'none')
```


Select a few countries with exponential growth in comparison with China:

```{r}
m5 %>%
  filter(Region=='US' | Region=='France' | Region=='Italy' | Region =='Sweden' | Region == 'Denmark' |
                Region=='Switzerland' | Region=='Norway' | Region=='China' | Region=='Spain' | 
           Region == 'Korea, South') %>% 
  filter(Confirmed>1000) %>%
  ggplot(aes(Date, Confirmed, col=Region)) + 
  geom_point() + 
  geom_smooth(se=FALSE) + #, method="lm", formula= (Confirmed ~ exp(Date))) + 
  scale_y_log10nice(limits=c(1000,1e6),name='confirmed COVID-19 cases') + 
  theme_bw()
# ggsave('confirmed-COVID-19-selectedRegions.png', width=6,height=4, dpi=150)
```


Renormalize the growth starting with the 1000th confirmed case. Here is the list of countries:

```{r}
m5a = subset(m5, Confirmed >= 1000)
m5a$DateDays = round(as.numeric(difftime( m5a$Date, '2020-02-14', units='days')))
q.dates = aggregate(m5a$Date, by=list(m5a$Region), FUN=min)
names(q.dates) = c('Region','Date')
#kable(q.dates[order(q.dates$Date),])
```

Make a graph with the trajectories from that point onwards:

```{r}
m8 = data.frame()
for(q in 1:nrow(q.dates)) {
  #print(q.dates$Region[q])
  if (!(q.dates$Region[q] %in% c('Cruise Ship','Denmark','Qatar','Diamond Princess','Serbia','North Macedonia'))) {
    d1 = subset(m5a, Region == q.dates$Region[q])
    d1$DateDaysNorm = round(as.numeric(d1$DateDays - difftime(q.dates$Date[q],'2020-02-14', units='days')))
    d1$Population = getPopulation(as.character(levels(q.dates$Region)[q.dates$Region[q]]))
    m8 = rbind(m8, d1)
  }
}
ggplot(m8, aes(DateDaysNorm, Confirmed, col=Region)) + 
  geom_line(size=1, alpha=0.5) + 
  geom_point(data=subset(m8,Region=='US'), size=3) +
  scale_y_log10nice(name='Confirmed COVID-19 Cases') + 
  scale_x_continuous(limits=c(0,32)) + xlab('Days since 100th confirmed case') + 
  theme_bw() + 
  theme(legend.position = 'none')
# ggsave('renormalized-COVID-19-confirmed.png',width=6,height=4, dpi=150)
```


Scale by population of the country:


```{r}
m8 %>% 
  group_by(Region) %>%
  filter(DateDaysNorm<55) %>%
  summarize(Confirmed = max(Confirmed),
            Population=max(Population), 
            DateDaysNorm = max(DateDaysNorm)) -> m8z

ggplot(m8z, aes(DateDaysNorm, Confirmed/Population*1e6, col=Region)) + 
  geom_line(data=subset(m8, Population>7e6), size=1, alpha=0.8) + 
  geom_line(data=subset(m8, Population<7e6), alpha=0.3) + 
  scale_y_log10nice(name='Confirmed COVID-19 Cases per Million Population') + 
  scale_x_continuous(limits=c(0,60)) + xlab('Days since 1000th confirmed case') + 
  geom_label_repel(data=subset(m8z, Population>7e6),aes(label=Region),hjust=-0.2) + 
  theme_bw() + theme(legend.position = 'none')
```

```{r}
m8s = subset(m8, Region=='US' | Region=='India' | Region=='Korea, South' | Region =='Sweden' | Region == 'Denmark' | Region=='Switzerland' | Region=='Japan' | Region=='China' | Region=='Italy' | Region=='Norway')
m8s %>% 
  group_by(Region) %>%
  filter(DateDaysNorm<50) %>%
  summarize(Confirmed = max(Confirmed),
            Population=max(Population), 
            DateDaysNorm = max(DateDaysNorm)) -> m8z
ggplot(m8, aes(DateDaysNorm, Confirmed/Population*1e6, col=Region)) + 
  geom_line(alpha=0.3) + 
  geom_line(data = m8s, size=1, alpha=0.8) + 
  scale_y_log10nice(name='Confirmed COVID-19 per Million Ppl') + 
  scale_x_continuous(limits=c(0,60)) + xlab('Days since 100th confirmed case') + 
  geom_label_repel(data=m8z,aes(label=Region),hjust=-0.2) + 
  theme_bw(base_size=16) + theme(legend.position = 'none')
```


Add an exponential fit:

```{r}
m8a = subset(m8, Region == 'US')
A0 = m8a$Confirmed[1]
nls(data = subset(m8a, DateDaysNorm>35),
    Confirmed ~ A*exp(DateDaysNorm/T1),
    start = list( A=m8a$Confirmed[10], T1=4)) -> fit
m8b = data.frame(DateDaysNorm = 20:50,
                 Confirmed = predict(fit, list(DateDaysNorm=20:50)))
T1 = signif(summary(fit)$coeff[2],2)
ggplot(m8a, aes(DateDaysNorm, Confirmed)) + 
  geom_point(col='red', size=2) + 
  geom_line(data=m8b) + ylab('Confirmed COVID-19 cases') + 
  ggtitle(paste('US since',min(m8a$Date),' doubling time:',T1,'days')) + xlab('days') + 
  scale_y_continuous(limits=c(0,1e6)) + 
  scale_x_continuous(limits=c(0,52), breaks=0:7*7, minor_breaks=0:60) +
  theme_bw()
summary(fit)
```

Semi-log plot:

```{r}
ggplot(m8a, aes(DateDaysNorm, Confirmed)) + 
  geom_point(col='red', size=2) + 
  geom_line(data=m8b) + ylab('confirmed COVID-19 cases') + 
  ggtitle(paste('US since',min(m8a$Date),' doubling time:',T1,'days')) + xlab('days') +
  scale_y_log10nice(name='Confirmed COVID-19 cases') + 
  scale_x_continuous(limits=c(0,44), breaks=0:5*11, minor_breaks=0:48) +
  geom_text(data = subset(m8a, DateDaysNorm==max(DateDaysNorm)),
                          aes(label = Date), hjust=-0.2) + 
  theme_bw()
```


## Growth rates

Growth rates since 100th confirmed case in different countries for the first 15 days compared with the range from 15-30 days. If the dark line is on the right, then the doubling time is decreasing; if the dark line is left, it means that doubling time is getting faster.

```{r}
result = data.frame()
for (r in levels(droplevels(m8$Region))) {
  m8a = subset(m8, Region == r)
  m8b = subset(m8a, DateDaysNorm <= 15)
  if (nrow(m8b)>5) {
    A0 = m8b$Confirmed[1]
    nls(data = m8b,
      Confirmed ~ A0*exp(DateDaysNorm/T1),
      start = list(T1=3)) -> fit
    m8b = subset(m8a, DateDaysNorm >= 15 & DateDaysNorm <= 30)
    #plot(m8b$DateDaysNorm, m8b$Confirmed)
    A0 = m8b$Confirmed[1]
    if (nrow(m8b)>5) {
      nls(data = m8b,
        Confirmed ~ A0*exp((DateDaysNorm-10)/T1),
        start = list(T1=3)) -> fit2
      r1 =  data.frame(
        Region = r,
        T = summary(fit)$coeff[1],
        T.sd = summary(fit)$coeff[2],
        T2 = summary(fit2)$coeff[1],
        T2.sd = summary(fit2)$coeff[2],
        len = nrow(m8b)
        )
      result=rbind(result,r1)
    }
  }
}

ggplot(result, aes(x=reorder(Region,-T2), y=T2)) + 
  geom_crossbar(aes(ymin=T2, ymax=T), fill='green') + xlab('Region') +
  geom_crossbar(data = subset(result, T2 < T),
                aes(ymin=T2, ymax=T), fill='orange') +
  scale_y_log10(limits=c(3,100)) + ylab('confirmed cases doubling time (days)') + 
  coord_flip() +
  theme_bw() +
  theme(legend.position = 'none')
```



## Deaths

Graphing some countries with exponentially growing death rates at the moment:

```{r}
filename = 'time_series_covid19_deaths_global.csv' #file.list[2]
f = file.path(path.series, filename)
d = read.csv(f)
d1 = d[,-c(1,3,4)]
m1 = melt(d1)
names(m1) = c('Region','Date','Confirmed')
m1$Date = gsub('^X','',as.character(levels(m1$Date)[m1$Date]))
m1$Date = as.Date(m1$Date, format='%m.%d.%y')
m4 = aggregate(m1$Confirmed, by=list(m1$Region, m1$Date), FUN=sum)
names(m4) = c('Region','Date','Confirmed')
m4p = which(m4$Region %in% top.regions)
m5 = m4[m4p,]
#ggplot(subset(m5, Region=='US' | Region=='France' | Region=='Italy' | 
#                Region=='Switzerland' | Region=='Iran' |  Region=='Spain' | Region=='Korea, South'), aes(Date, Confirmed, #col=Region, shape=Region)) + 
#  geom_point() + 
#  scale_y_log10nice(limits=c(2,2e4)) + 
#  scale_shape_manual(values=1:nlevels(m5$Region)) +
#  theme_bw()
```




```{r}
m5$DateDays = round(as.numeric(difftime( m5$Date, '2020-02-14', units='days')))
m5 %>%
  filter(Region=='US' | Region=='France' | Region=='Italy' | Region=='China' | Region == 'Sweden' |
                Region=='Switzerland' | Region=='Iran' |  Region=='Spain' | Region=='Korea, South') %>%
  filter(Confirmed>5) %>%
  ggplot(aes(DateDays, Confirmed, col=Region, shape=Region)) + 
  geom_point() + 
  scale_x_continuous(limits=c(-30,80)) + xlab('days since Valentine')+ 
  scale_y_log10nice(limits=c(5,2e5), name='COVID-19 Deaths') + ylab('Deaths') + 
  scale_shape_manual(values=1:nlevels(m5$Region)) +
  theme_bw()
```


Renormalizing the start dates for `recorded deaths`, we find the dates when the `100th death` was recorded in each country:

```{r}
m6= subset(m5, Confirmed >= 100)
q1 = aggregate(m6$DateDays, by=list(m6$Region), FUN=min)
names(q1) = c('Country','Start')
#kable(q1[order(q1$Start),])
```



```{r}
m7 = data.frame()
for(q in 1:nrow(q1)) {
  d1 = subset(m6, Region == q1$Country[q])
  d1$DateDaysNorm = d1$DateDays - q1$Start[q]
  m7 = rbind(m7, d1)
}
```


```{r}
c.list = c('China','Spain','Italy','Iran','Japan','Korea, South','Switzerland','US')
ggplot(subset(m7, Region %in% c.list), aes(DateDaysNorm, Confirmed, col=Region)) + 
  geom_path(data=m7, col='grey', aes(group=Region)) + 
  geom_point() + 
  scale_x_continuous(limits=c(-0,50)) + xlab('days since 50th death in region')+ 
  scale_y_log10nice(limits=c(50,1e5), name='COVID-19 Deaths') + ylab('Deaths') + 
  scale_shape_manual(values=1:nlevels(m5$Region)) +
  theme_bw()
```


Trying to add a fit line:

```{r}
m7v = subset(m7, Region=='US')
m7u = subset(m7v, DateDaysNorm >= 30)
nls(data = m7u, Confirmed ~ A*exp((DateDaysNorm-30)/T),
    start = list(A=min(m7u$Confirmed), T =3)) -> fit
m7u.fit = data.frame(DateDaysNorm = 0:50,
                     Confirmed = predict(fit, list(DateDaysNorm=0:50)))
m7u.fit$Region = 'US'
ggplot(m7v, aes(DateDaysNorm, Confirmed, col=Region)) + 
  geom_path(data=m7, size=0.2) + geom_point(size=3, col='black') +
  geom_point(size=2) + geom_path() +
  geom_line(data=m7u.fit, col='blue') + 
  scale_x_continuous(limits=c(-0,50)) + 
  xlab('days since 50th death in region')+ 
  scale_y_log10nice(limits=c(100,1e5), name='COVID-19 Deaths') +  
  scale_shape_manual(values=1:nlevels(m5$Region)) +
  theme_bw() + theme(legend.position = 'none') #c(0.01,0.95),
                     #legend.justification = c(0,1))
```

Renormalize by population:

```{r}
m8 = data.frame()
for(r in levels(m7$Region)) {
  d1 = subset(m7, Region==r)
  if (nrow(d1)>10) {
    d1$Population = getPopulation(r)
    m8 = rbind(m8, d1)
  }
}
m8 %>%
  filter(Confirmed/Population*1e6 >= 1) %>%
  ggplot(aes(DateDaysNorm, Confirmed/Population*1e6, col=Region)) + 
  geom_path(data=subset(m8,Region=='US'),size=2, col='black') +
  geom_path(size=1) +
  scale_x_continuous(limits=c(-0,50)) + xlab('days since 50th death in region')+ 
  scale_y_log10nice( name='COVID-19 Deaths per Million ppl') + 
  scale_shape_manual(values=1:nlevels(m5$Region)) +
  theme_bw()
```




```{r}
droplevels(m8$Region) -> m8$Region
m8$ConfDiff = unlist(by(m8$Confirmed, m8$Region, function(x) { c(0, diff(x)) } ))
m8 %>%
  filter(Region=='Spain' | Region=='Germany' | Region=='US' | Region == 'Sweden' | 
           Region=='Korea, South' | Region=='China' | Region=='Switzerland') %>%
  filter(ConfDiff>10) %>%
  ggplot(aes(DateDays, ConfDiff/Population*1e6, color=Region)) + 
  scale_y_log10() + 
  geom_point() + geom_path() + 
  ylab('Daily COVID-19 Deaths per Million Population') +
  xlab('Date since Valentine') + 
  theme_bw()
```
